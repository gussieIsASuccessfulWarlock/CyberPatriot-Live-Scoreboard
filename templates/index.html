<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=500px, initial-scale=1.0">
    <title>CyberPatriots Live Scoreboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="/assets/styles.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        var socket = io('{{host}}', {
            transports: ['polling'],
            reconnection: true,
            reconnectionAttempts: 50,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            pingTimeout: 60000  // Increase to avoid background tab kills
        });
        var last_update = [];
        let lastSuccessfulUpdate = Date.now();
        var pollInterval;
        let isReconnecting = false;

        socket.emit("get_teams");
        socket.emit("get_scores");

        socket.on('connect', () => {
            lastSuccessfulUpdate = Date.now();
            clearAlert('connection_lost');
        });

        socket.on("teams", function (data) {
            lastSuccessfulUpdate = Date.now();
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(function () {
                if (last_update.length === 0) {
                    noDataAlert();
                } else {
                    dataAvailableClear();
                }
                if (Date.now() - lastSuccessfulUpdate > 3000 && !isReconnecting) {
                    if (pollInterval) clearInterval(pollInterval);
                    showAlert("Connection Lost! Attempting to Reconnect...", "connection_lost");
                    socket.emit("get_teams");
                    return;
                } else {
                    clearAlert("connection_lost");
                    socket.emit("get_score_update", last_update);
                }
            }, 1000);
        });

        socket.on("get_score_update", function (data) {
            lastSuccessfulUpdate = Date.now();
            last_update = data;
            generateTop4(data);
            generateTable(data);
        });

        socket.on("updated", function (data) {
            lastSuccessfulUpdate = Date.now();
            let date = new Date(data * 1000);
            document.getElementById("updtime").innerText = date.toLocaleString();
            clearAlert('connection_lost');
        });

        socket.on("scores", function (data) {
            lastSuccessfulUpdate = Date.now();
            last_update = data;
            generateTop4(data);
            generateTable(data);
        });

        function generateTop4(data) {
            let top4Teams = data
                .sort((a, b) => b.score - a.score)
                .slice(0, 4);
            if (top4Teams.length === 0) {
                return;
            }
            const container = document.getElementById('top-4');
            if (!container) {
                console.error('Div with id "top-4" not found.');
                return;
            }

            const configs = [
                {
                    borderClass: 'terminal-border-1',
                    borderColor: 'border-sky-500',
                    titleColor: 'text-sky-300',
                    rank: 1
                },
                {
                    borderClass: 'terminal-border-2',
                    borderColor: 'border-lime-500',
                    titleColor: 'text-lime-300',
                    rank: 2
                },
                {
                    borderClass: 'terminal-border-3',
                    borderColor: 'border-pink-500',
                    titleColor: 'text-pink-300',
                    rank: 3
                },
                {
                    borderClass: 'terminal-border-4',
                    borderColor: 'border-amber-500',
                    titleColor: 'text-amber-300',
                    rank: 4
                }
            ];

            let html = '';
            configs.forEach(config => {
                html += `
            <div class="${config.borderClass} w-full min-w-[280px] w-full ${config.borderColor} border-2 p-4 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm">
                <h1 class="glow text-green-300 w-full text-right text-lg font-bold"><span class="text-xs mr-0.5">#</span>${config.rank}</h1>
                <h1 class="glow ${config.titleColor} font-black text-5xl tracking-wider mb-2">${top4Teams[config.rank - 1]["team_number"]}</h1>
                <div class="grid grid-cols-2 gap-2 w-full">
                    <div class="p-2 border border-cyan-500/60 bg-black/80 text-cyan-300 flex items-center gap-2 font-bold tracking-wide hover:border-cyan-400 transition-all">
                        <svg class="scale-[0.8]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-monitor-play-icon lucide-monitor-play"><path d="M15.033 9.44a.647.647 0 0 1 0 1.12l-4.065 2.352a.645.645 0 0 1-.968-.56V7.648a.645.645 0 0 1 .967-.56z"/><path d="M12 17v4"/><path d="M8 21h8"/><rect x="2" y="3" width="20" height="14" rx="2"/></svg>
                        <span>${top4Teams[config.rank - 1]["images"]}</span>
                    </div>
                    <div class="p-2 border border-cyan-500/60 bg-black/80 text-cyan-300 flex items-center gap-2 font-bold tracking-wide hover:border-cyan-400 transition-all">
                        <svg class="scale-[0.8]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clock-icon lucide-clock"><path d="M12 6v6l4 2"/><circle cx="12" cy="12" r="10"/></svg>
                        <span>${top4Teams[config.rank - 1]["score_time"]}</span>
                    </div>
                    <div class="p-2 border border-green-500/60 bg-black/80 text-green-300 flex items-center gap-2 font-bold tracking-wide hover:border-green-400 transition-all">
                        <svg class="scale-[0.8]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-star-icon lucide-circle-star"><path d="M11.051 7.616a1 1 0 0 1 1.909.024l.737 1.452a1 1 0 0 0 .737.535l1.634.256a1 1 0 0 1 .588 1.806l-1.172 1.168a1 1 0 0 0-.282.866l.259 1.613a1 1 0 0 1-1.541 1.134l-1.465-.75a1 1 0 0 0-.912 0l-1.465.75a1 1 0 0 1-1.539-1.133l.258-1.613a1 1 0 0 0-.282-.867l-1.156-1.152a1 1 0 0 1 .572-1.822l1.633-.256a1 1 0 0 0 .737-.535z"/><circle cx="12" cy="12" r="10"/></svg>
                        <span>${top4Teams[config.rank - 1]["ccs_score"]}</span>
                    </div>
                    <div class="p-2 border border-red-500/60 bg-black/80 text-red-300 flex items-center gap-2 font-bold tracking-wide hover:border-red-400 transition-all">
                        <svg class="scale-[0.8]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gavel-icon lucide-gavel"><path d="m14 13-8.381 8.38a1 1 0 0 1-3.001-3l8.384-8.381"/><path d="m16 16 6-6"/><path d="m21.5 10.5-8-8"/><path d="m8 8 6-6"/><path d="m8.5 7.5 8 8"/></svg>
                        <span>${top4Teams[config.rank - 1]["adjustment"] ? top4Teams[config.rank - 1]["adjustment"] : top4Teams[config.rank - 1]["code"] === "" ? "0" : top4Teams[config.rank - 1]["code"]}</span>
                    </div>
                    <div class="p-3 border-2 border-yellow-500/70 bg-black/90 text-yellow-300 flex items-center justify-center gap-2 col-span-2 font-black text-lg tracking-wider hover:border-yellow-400 transition-all">
                        <svg class="scale-[0.9]" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trophy-icon lucide-trophy"><path d="M10 14.66v1.626a2 2 0 0 1-.976 1.696A5 5 0 0 0 7 21.978"/><path d="M14 14.66v1.626a2 2 0 0 0 .976 1.696A5 5 0 0 1 17 21.978"/><path d="M18 9h1.5a1 1 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M6 9a6 6 0 0 0 12 0V3a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1z"/><path d="M6 9H4.5a1 1 0 0 1 0-5H6"/></svg>
                        <span>${top4Teams[config.rank - 1]["total"] ? top4Teams[config.rank - 1]["total"] : top4Teams[config.rank - 1]["ccs_score"]}</span>
                    </div>
                </div>
            </div>
        `;
            });

            container.innerHTML = html;
        }

        function generateTable(data) {
            let tableTeams = data
                .sort((a, b) => b.score - a.score).splice(4);
            if (tableTeams.length === 0) {
                return;
            }
            const container = document.getElementById('score-table-body');
            if (!container) {
                console.error('Div with id "score-table-body" not found.');
                return;
            }
            let html = '';
            tableTeams.forEach(team => {
                let i = tableTeams.indexOf(team);
                html += `
                    <tr class="text-lime-300">
                        <td class="px-4 py-0.5 font-bold">${i + 5}</td>
                        <td class="px-4 py-0.5">${team['team_number']}</td>
                        <td class="px-4 py-0.5">${team['images']}</td>
                        <td class="px-4 py-0.5">${team['score_time']}</td>
                        <td class="px-4 py-0.5">${team['ccs_score']}</td>
                        <td class="px-4 py-0.5">${team['adjustment'] ? team['adjustment'] : team['code'] === "" ? "0" : team['code']}</td>
                        <td class="px-4 py-0.5 text-right">${team['total'] ? team['total'] : team['ccs_score']}</td>
                    </tr>
                `;
            });
            container.innerHTML = html;
        }
        let alerts = {};
        function refreshAlerts() {
            let alertDiv = document.getElementById('alerts');
            alertDiv.innerHTML = '';
            for (let key in alerts) {
                if (alerts[key].visible) {
                    alertDiv.innerHTML += `<div class="terminal-error w-full min-w-[280px] flex w-full border-red-500 border-2 p-4 flex gap-2 items-center justify-center bg-black/60 backdrop-blur-sm max-w-7xl">
                    <svg class="scale-[0.8] text-red-400" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-octagon-alert-icon lucide-octagon-alert"><path d="M12 16h.01"/><path d="M12 8v4"/><path d="M15.312 2a2 2 0 0 1 1.414.586l4.688 4.688A2 2 0 0 1 22 8.688v6.624a2 2 0 0 1-.586 1.414l-4.688 4.688a2 2 0 0 1-1.414.586H8.688a2 2 0 0 1-1.414-.586l-4.688-4.688A2 2 0 0 1 2 15.312V8.688a2 2 0 0 1 .586-1.414l4.688-4.688A2 2 0 0 1 8.688 2z"/></svg>
                    <p class="text-red-400 font-bold text-center">${alerts[key].message}</p>
                    </div>`;
                }
            }
        }
        function showAlert(message, id) {
            alerts[id] = {
                message: message,
                timestamp: Date.now(),
                visible: true
            };
            refreshAlerts();
        }
        function clearAlert(id) {
            if (alerts[id]) {
                delete alerts[id];
                refreshAlerts();
            }
        }
        function clearAllAlerts() {
            for (let key in alerts) {
                alerts[key].visible = false;
            }
            refreshAlerts();
        }

        function noDataAlert() {
            showAlert("No Active Teams Yet...", "no_data");
            document.getElementById("uptext").style.display = "none";
            document.getElementById("tableac").style.display = "none";
        }
        function dataAvailableClear() {
            clearAlert("no_data");
            document.getElementById("uptext").style.display = "";
            document.getElementById("tableac").style.display = "";
        }
        noDataAlert();
    </script>
</head>

<body>
    <div class="p-4 pt-16 flex flex-col gap-4 items-center">
        <img src="/assets/logo.png" alt="Platform Logo"
            style="width:500px; filter: drop-shadow(0 0 8px rgba(14, 165, 233, 0.4));">
        <div id="alerts" class="w-full flex flex-col items-center justify-center gap-2 pt-4">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-2 w-full max-w-7xl" id="top-4">
        </div>
        <div class="flex justify-end w-full max-w-7xl">
            <p class="text-right text-lime-300" id="uptext">Last Update: <span id="updtime"></span></p>
        </div>
        <div
            id="tableac"
            class="max-w-7xl terminal-border-5 w-full min-w-[280px] w-full border-2 border-zinc-500 p-4 flex flex-col items-center justify-center bg-black/60 backdrop-blur-sm">
            <table class="w-full">
                <thead>
                    <tr>
                        <th class="px-4 py-2 text-left text-sky-400"></th>
                        <th class="px-4 py-2 text-left text-sky-400">Team ID</th>
                        <th class="px-4 py-2 text-left text-sky-400">Images</th>
                        <th class="px-4 py-2 text-left text-sky-400">Score Time</th>
                        <th class="px-4 py-2 text-left text-sky-400">CCS Score</th>
                        <th class="px-4 py-2 text-left text-sky-400">Penalties</th>
                        <th class="px-4 py-2 text-left text-sky-400 text-right">Total Score</th>
                    </tr>
                </thead>
                <tbody id="score-table-body">
                </tbody>
            </table>
        </div>
    </div>
</body>

</html>